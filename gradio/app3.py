# app3.py

import gradio as gr
from models import load_all_models
from pipeline import run_hybrid_rag_pipeline # [ìˆ˜ì •] ìƒˆë¡œ ë°”ë€ í•¨ìˆ˜ ì´ë¦„ ì„í¬íŠ¸
from PIL import Image

# --- 1. ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹œ ëª¨ë¸ ë¡œë”© ---
print(" App3 ì‹œì‘... ëª¨ë“  ëª¨ë¸ ë¡œë”©ì„ ì‹œì‘í•©ë‹ˆë‹¤. ")
try:
    ALL_MODELS = load_all_models()
    print("âœ¨ ëª¨ë“  ëª¨ë¸ê³¼ DBê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤. Gradio UIë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. âœ¨")
    MODELS_LOADED = True
except Exception as e:
    print(f"ğŸš¨ ì¹˜ëª…ì  ì˜¤ë¥˜: ëª¨ë¸ ë¡œë”©ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. {e}")
    MODELS_LOADED = False

# --- 2. Gradio ì¸í„°í˜ì´ìŠ¤ë¥¼ ìœ„í•œ ë˜í¼(Wrapper) í•¨ìˆ˜ ---
# [ìˆ˜ì •] í˜¸ì¶œí•  í•¨ìˆ˜ ì´ë¦„ ë³€ê²½
def gradio_interface_func(image, user_question, progress=gr.Progress(track_tqdm=True)):
    if not MODELS_LOADED:
        raise gr.Error("ëª¨ë¸ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì„œë²„ë¥¼ ì¬ì‹œì‘í•´ì£¼ì„¸ìš”.")
    
    return run_hybrid_rag_pipeline(image, user_question, ALL_MODELS, progress)

# --- 3. Gradio UI êµ¬ì„± ---
with gr.Blocks(theme=gr.themes.Soft(), title="Advanced RAG") as demo:
    gr.Markdown("# Advanced RAG Pipeline ğŸš€")
    gr.Markdown("ì´ë¯¸ì§€ ë¶„ì„(Ovis)ê³¼ ìµœì¢… ë‹µë³€(Qwen)ì— ì„œë¡œ ë‹¤ë¥¸ ëª¨ë¸ì„ ì‚¬ìš©í•˜ëŠ” RAG ì‹œìŠ¤í…œì…ë‹ˆë‹¤.")
    gr.Markdown("---")

    with gr.Row():
        with gr.Column(scale=1):
            gr.Markdown("## 1. ì…ë ¥")
            image_input = gr.Image(type="pil", label="ì´ë¯¸ì§€ ì—…ë¡œë“œ")
            question_input = gr.Textbox(label="ì§ˆë¬¸ ì…ë ¥", placeholder="ì´ë¯¸ì§€ì— ëŒ€í•´ ì§ˆë¬¸í•˜ì„¸ìš”...")
            submit_button = gr.Button("ë‹µë³€ ìƒì„±í•˜ê¸°", variant="primary")

        with gr.Column(scale=2):
            gr.Markdown("## 2. ê²°ê³¼")
            answer_output = gr.Textbox(label="ìµœì¢… ë‹µë³€ (Generated by Qwen)", interactive=False, lines=5, max_lines=15)
            with gr.Accordion("ìƒì„¸ ê³¼ì • ë³´ê¸°", open=False):
                desc_output = gr.Textbox(label="(1) ì´ë¯¸ì§€ ë¶„ì„ ê²°ê³¼ (by Ovis)", interactive=False, lines=5, max_lines=15)
                context_output = gr.Textbox(label="(2) ì§€ì‹ë² ì´ìŠ¤ ê²€ìƒ‰ ê²°ê³¼", interactive=False, lines=5, max_lines=15)

    if MODELS_LOADED:
        submit_button.click(
            fn=gradio_interface_func,
            inputs=[image_input, question_input],
            outputs=[answer_output, desc_output, context_output]
        )
    else:
        gr.Markdown("## ğŸš¨ ëª¨ë¸ ë¡œë”© ì‹¤íŒ¨! ğŸš¨ ì• í”Œë¦¬ì¼€ì´ì…˜ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

if __name__ == "__main__":
    demo.launch()