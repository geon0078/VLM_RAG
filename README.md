
# VLM-RAG 하이브리드 지하철 정보 시스템

## 1. 프로젝트 개요

본 프로젝트는 최신 시각 언어 모델(VLM)과 소형 언어 모델(LLM)을 결합한 하이브리드 RAG(검색 증강 생성) 파이프라인을 통해, **이미지와 자연어 질문을 동시에 이해하고 정확한 지하철 정보를 제공**하는 것을 목표로 합니다.

사용자는 지하철 관련 이미지를 제시하고 질문을 던지면, 시스템은 이미지를 분석하고, 자체적으로 구축한 벡터 데이터베이스에서 관련 정보를 검색하여, 이미지와 검색된 정보를 종합적으로 판단하여 신뢰도 높은 답변을 생성합니다.

---

## 2. 핵심 기능 및 아키텍처

### 2.1. 하이브리드 모델 아키텍처 (VLM + LLM)

본 시스템은 각기 다른 강점을 가진 두 종류의 모델을 조합하여 작업 효율과 정확도를 극대화합니다.

-   **VLM (Visual Language Model - `AIDC-AI/Ovis2-8B`)**: 이미지 분석, 이미지-텍스트 연관 추론, 최종 답변 생성 등 시각 정보와 언어 정보를 종합해야 하는 고차원적인 작업을 전담합니다.
-   **LLM (Language Model - `Qwen/Qwen2-1.5B-Instruct`)**: 텍스트만으로 수행 가능한 작업, 특히 사용자 질문에서 검색용 핵심 키워드를 추출하는 작업을 빠르고 효율적으로 처리합니다.

이러한 역할 분담을 통해 VLM의 텍스트 전용 작업 시 발생하는 기술적 제약(`KeyError: 'pixel_values'`)을 해결하고, 전체 파이프라인의 안정성과 효율성을 확보했습니다.

### 2.2. 메타데이터 기반 원자적 벡터 DB

검색 정확도를 높이기 위해, 기존의 비효율적인 "통문서" 저장 방식을 버리고 **"원자적(Atomic)" 정보 단위와 메타데이터**를 활용하는 새로운 벡터 DB를 설계했습니다.

-   **역 속성 정보 (`korean_knowledge_base_v3`)**: "서울역의 주소는 OOO입니다." 와 같이 각 역의 속성을 개별 문서로 분해하고, `{'역명': '서울역', '속성': '주소'}` 와 같은 메타데이터를 부여하여 저장합니다.
-   **역 연결 정보 (`subway_line_info_v1`)**: "4호선에서 서울역의 다음 역은 숙대입구입니다." 와 같이 역과 역 사이의 관계를 명확히 하는 문서를 생성하고, `{'노선': '4호선', '역': '서울역', '방향': '다음'}` 과 같은 메타데이터를 부여합니다.

이를 통해 질문과 가장 관련성이 높은 정보 조각만 정밀하게 검색하여, LLM에 전달되는 컨텍스트의 질을 크게 향상시켰습니다.

### 2.3. 시스템 실행 순서 (Flow)

```
1. 입력 (Input)
   - 사용자 이미지, 자연어 질문

2. 검색 단계 (Retrieval Stage)
   - [VLM]: 이미지 분석 → '이미지 설명' 생성
   - [LLM]: 질문 분석 → '핵심 키워드' 추출
   - [Vector DB]: '질문 원본' + '이미지 설명' + '핵심 키워드'로 확장된 쿼리를 사용하여, 메타데이터 기반 DB에서 관련 정보 검색

3. 생성 단계 (Generation Stage)
   - [VLM]: '이미지' + '이미지 설명' + '검색된 정보'를 Chain-of-Thought 프롬프트에 담아 종합적으로 추론
   - 최종 답변 및 근거 생성

4. 출력 (Output)
   - 사용자의 질문에 대한 답변
```

---

## 3. 디렉토리 구조

```
VLM_RAG/
├── make_vector_db_/       # 벡터 DB 생성을 위한 스크립트 모음
│   ├── make_vector_db_v2.py # 역 속성 정보 DB 생성 (v3 컬렉션)
│   └── line_data_v2.py      # 역 연결 정보 DB 생성 (v1 컬렉션)
│
├── v2/                      # 최종 애플리케이션
│   ├── main.py              # 메인 실행 파일
│   ├── config.py            # 모델 경로, DB 컬렉션 이름, 프롬프트 등 설정
│   └── module/              # 기능별 모듈
│       ├── models.py        # VLM, LLM, 임베딩 모델 로딩
│       ├── retrieval.py     # 검색(이미지 설명, 키워드 추출, 벡터 검색) 담당
│       └── generation.py    # 최종 답변 생성 담당
│
├── data/                    # DB 생성을 위한 원본 데이터
│   ├── korean_train_20250101.xlsx
│   └── csv/
│       └── *.csv
│
└── images/                  # 테스트용 이미지
    └── *.jpg
```

---

## 4. 설치 및 사용법

### 4.1. 설치

1.  **가상환경 생성 및 활성화**
    ```bash
    python -m venv venv
    source venv/bin/activate
    ```

2.  **필요 라이브러리 설치**
    ```bash
    pip install torch pandas sentence_transformers transformers chromadb openpyxl tabulate
    ```

### 4.2. 사용법

**1단계: 벡터 데이터베이스 생성 (최초 1회 실행)**

애플리케이션을 실행하기 전에, 검색에 필요한 벡터 데이터베이스를 먼저 생성해야 합니다.

```bash
# 1. 역 속성 정보 DB 생성
python make_vector_db_/make_vector_db_v2.py

# 2. 역 연결(노선) 정보 DB 생성
python make_vector_db_/line_data_v2.py
```

**2단계: RAG 파이프라인 실행**

`v2/main.py`를 실행하여 RAG 파이프라인을 가동합니다. `config.py`에 기본 이미지와 질문이 설정되어 있어 바로 실행 가능합니다.

```bash
python v2/main.py
```

**커맨드 라인 인자 사용**

다른 이미지나 질문으로 테스트하고 싶을 경우, 다음과 같이 커맨드 라인 인자를 사용할 수 있습니다.

```bash
python v2/main.py \
    --image_path ./images/hapjeong_station.jpg \
    --question "이 역은 몇 호선이고 다음 역은 어디인가요?"
```

---

## 5. 기술적 발전 과정 (v1 → v2)

-   **v1**: VLM 단일 모델과 통문서 기반의 단순 RAG 파이프라인으로 시작. 이후 모듈화 리팩토링 진행.
-   **v2**: 멀티모달 검색, CoT 프롬프트 도입으로 성능 개선.
-   **v2 (문제 봉착)**: VLM을 이용한 키워드 추출 시도 중, VLM이 텍스트 전용 입력을 처리하지 못하는 `KeyError` 발생.
-   **v2 (하이브리드 아키텍처 도입)**: 문제 해결을 위해 키워드 추출 전용 소형 LLM(Qwen)을 도입하여, VLM과 LLM이 협력하는 현재의 안정적인 하이브리드 구조 완성.
-   **DB 고도화**: 검색 정확도 향상을 위해, 메타데이터 기반의 원자적 문서화 전략을 도입하여 현재의 정밀 검색이 가능한 DB 구조 완성.
